name: CI/CD for Spring Boot Application

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1.1 리포지토리 체크아웃
    - name: Checkout code
      uses: actions/checkout@v3

    # 1.2 Gradle 실행 권한 부여
    - name: Give Gradle wrapper execute permission
      run: chmod +x ./gradlew

    # 1.3 Java 버전 설정
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # 1.4 Gradle 빌드 실행
    - name: Build with Gradle
      run: |
        ./gradlew clean build

    # 1.5 빌드 결과물 전송 (SCP 명령어 사용)
    - name: Upload build artifact to Lightsail
      env:
        LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      run: |
        echo "${LIGHTSAIL_SSH_KEY}" > lightsail.pem
        chmod 600 lightsail.pem  # 권한 설정
        scp -i lightsail.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null build/libs/*.jar ubuntu@${LIGHTSAIL_HOST}:/home/ubuntu/app/
        rm lightsail.pem

    # 1.6 Lightsail에서 애플리케이션 실행
    - name: Start application on Lightsail
      env:
        LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
      run: |
        echo "${LIGHTSAIL_SSH_KEY}" > lightsail.pem
        chmod 600 lightsail.pem  # 권한 설정
        ssh -i lightsail.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${LIGHTSAIL_HOST} << 'EOF'
          # 기존 실행 중인 Java 애플리케이션 종료
          pkill -f 'java -jar' || true
      
          # 새 애플리케이션 실행 (로그 파일로 리디렉션)
          nohup java -jar /home/ubuntu/app/cicd-0.0.1-SNAPSHOT.jar > /home/ubuntu/app/app.log 2>&1 &
      
          # 프로세스 세션 분리
          disown
        EOF
        rm lightsail.pem


    # Docker 관련 부분 주석 처리
    # - name: Docker Build
    #   run: docker build -t my-spring-boot-app . 
    # - name: Docker Push
    #   run: docker push my-docker-repo/my-spring-boot-app:latest
