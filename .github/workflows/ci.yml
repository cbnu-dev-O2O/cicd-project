name: CI/CD for Spring Boot Application

on:
  push:
    branches: ["master"]

jobs:
  # 1. Build Job
  build:
    runs-on: ubuntu-latest
    steps:
    # 1.1 리포지토리 체크아웃
    - name: Checkout code
      uses: actions/checkout@v3

    # 1.2 Java 버전 설정
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # 1.3 Gradle 빌드 실행
    - name: Build with Gradle
      run: |
        ./gradlew clean build

    # 1.4 빌드 결과물 아티팩트로 저장
    - name: Save build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifact
        path: build/libs/*.jar

  # 2. Deploy Job (현재는 주석 처리)
  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build  # Build Job이 완료된 후 실행
  #   steps:
  #   # 2.1 빌드 결과물 다운로드
  #   - name: Download build artifacts
  #     uses: actions/download-artifact@v3
  #     with:
  #       name: build-artifact

  #   # 2.2 빌드 결과물 전송
  #   - name: Upload build artifacts to Lightsail
  #     uses: appleboy/scp-action@v0.1.2
  #     with:
  #       host: ${{ secrets.LIGHTSAIL_HOST }}
  #       username: ubuntu
  #       key: ${{ secrets.LIGHTSAIL_KEY }}
  #       source: build-artifact/*.jar
  #       target: /home/ubuntu/app

  #   # 2.3 Lightsail에서 애플리케이션 실행
  #   - name: Start application on Lightsail
  #     uses: appleboy/ssh-action@v0.1.2
  #     with:
  #       host: ${{ secrets.LIGHTSAIL_HOST }}
  #       username: ubuntu
  #       key: ${{ secrets.LIGHTSAIL_KEY }}
  #       script: |
  #         pkill -f 'java -jar' || true # 기존 애플리케이션 종료
  #         nohup java -jar /home/ubuntu/app/*.jar > /home/ubuntu/app/app.log 2>&1 &
